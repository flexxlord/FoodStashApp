{"version":3,"file":"reactnavigationv4.js","sourceRoot":"","sources":["../../../src/js/tracing/reactnavigationv4.ts"],"names":[],"mappings":"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","sourcesContent":["import { Transaction } from \"@sentry/types\";\nimport { logger } from \"@sentry/utils\";\n\nimport { BeforeNavigate } from \"./reactnativetracing\";\nimport {\n  RoutingInstrumentation,\n  TransactionCreator,\n} from \"./routingInstrumentation\";\nimport { ReactNavigationTransactionContext } from \"./types\";\n\nexport interface NavigationRouteV4 {\n  routeName: string;\n  key: string;\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  params?: Record<string, any>;\n}\n\nexport interface NavigationStateV4 {\n  index: number;\n  key: string;\n  isTransitioning: boolean;\n  routeName?: string;\n  routes: (NavigationRouteV4 | NavigationStateV4)[];\n}\n\nexport interface AppContainerInstance {\n  _navigation: {\n    state: NavigationStateV4;\n    router: {\n      getStateForAction: (\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        action: any,\n        state: NavigationStateV4\n      ) => NavigationStateV4;\n    };\n  };\n}\n\ninterface AppContainerRef {\n  current?: AppContainerInstance | null;\n}\n\n/**\n * Instrumentation for React-Navigation V4.\n * Register the app container with `registerAppContainer` to use, or see docs for more details.\n */\nclass ReactNavigationV4Instrumentation extends RoutingInstrumentation {\n  static instrumentationName: string = \"react-navigation-v4\";\n\n  private _appContainerRef: AppContainerRef = { current: null };\n\n  private readonly _maxRecentRouteLen: number = 200;\n\n  private _prevRoute?: NavigationRouteV4;\n  private _recentRouteKeys: string[] = [];\n\n  private _latestTransaction?: Transaction;\n  private _shouldUpdateLatestTransaction: boolean = false;\n\n  /**\n   * Extends by calling _handleInitialState at the end.\n   */\n  public registerRoutingInstrumentation(\n    listener: TransactionCreator,\n    beforeNavigate: BeforeNavigate\n  ): void {\n    super.registerRoutingInstrumentation(listener, beforeNavigate);\n\n    // Need to handle the initial state as the router patch will only attach transactions on subsequent route changes.\n    this._handleInitialState();\n  }\n\n  /**\n   * Pass the ref to the app container to register it to the instrumentation\n   * @param appContainerRef Ref to an `AppContainer`\n   */\n  public registerAppContainer(\n    appContainerRef: AppContainerRef | AppContainerInstance\n  ): void {\n    if (\"current\" in appContainerRef) {\n      this._appContainerRef = appContainerRef;\n    } else {\n      this._appContainerRef = {\n        current: appContainerRef as AppContainerInstance,\n      };\n    }\n\n    if (!this._appContainerRef?.current) {\n      logger.error(\n        \"[ReactNavigationV4Instrumentation]: App container ref is incorrect, instrumentation will not attach.\"\n      );\n    } else {\n      this._patchRouter();\n\n      if (this._shouldUpdateLatestTransaction) {\n        this._updateLatestTransaction();\n        this._shouldUpdateLatestTransaction = false;\n      }\n    }\n  }\n\n  /**\n   * Starts an idle transaction for the initial state which won't get called by the router listener.\n   */\n  private _handleInitialState(): void {\n    this._latestTransaction = this.onRouteWillChange(\n      INITIAL_TRANSACTION_CONTEXT_V4\n    );\n\n    // We set this to true so when registerAppContainer is called, the transaction gets updated with the actual route data\n    this._shouldUpdateLatestTransaction = true;\n  }\n\n  /**\n   * Updates the latest transaction with the current state and calls beforeNavigate.\n   */\n  private _updateLatestTransaction(): void {\n    // We can assume the ref is present as this is called from registerAppContainer\n    if (this._appContainerRef.current && this._latestTransaction) {\n      const state = this._appContainerRef.current._navigation.state;\n      this._onStateChange(state, true);\n    }\n  }\n\n  /**\n   * Patches the react navigation router so we can listen to the route changes and attach the `IdleTransaction` before the\n   * new screen is mounted.\n   */\n  private _patchRouter(): void {\n    if (this._appContainerRef.current) {\n      const originalGetStateForAction = this._appContainerRef.current\n        ._navigation.router.getStateForAction;\n\n      this._appContainerRef.current._navigation.router.getStateForAction = (\n        action,\n        state\n      ) => {\n        const newState = originalGetStateForAction(action, state);\n\n        this._onStateChange(newState);\n\n        return newState;\n      };\n    }\n  }\n\n  /**\n   * To be called on navigation state changes and creates the transaction.\n   */\n  private _onStateChange(\n    state: NavigationStateV4,\n    updateLatestTransaction: boolean = false\n  ): void {\n    const currentRoute = this._getCurrentRouteFromState(state);\n\n    // If the route is a different key, this is so we ignore actions that pertain to the same screen.\n    if (!this._prevRoute || currentRoute.key !== this._prevRoute.key) {\n      const originalContext = this._getTransactionContext(\n        currentRoute,\n        this._prevRoute\n      );\n      let finalContext = this._beforeNavigate?.(originalContext);\n\n      // This block is to catch users not returning a transaction context\n      if (!finalContext) {\n        logger.error(\n          `[ReactNavigationV4Instrumentation] beforeNavigate returned ${finalContext}, return context.sampled = false to not send transaction.`\n        );\n\n        finalContext = {\n          ...originalContext,\n          sampled: false,\n        };\n      }\n\n      if (finalContext.sampled === false) {\n        this._onBeforeNavigateNotSampled(finalContext.name);\n      }\n\n      if (updateLatestTransaction && this._latestTransaction) {\n        // Update the latest transaction instead of calling onRouteWillChange\n        this._latestTransaction.updateWithContext(finalContext);\n      } else {\n        this._latestTransaction = this.onRouteWillChange(finalContext);\n      }\n\n      this._pushRecentRouteKey(currentRoute.key);\n      this._prevRoute = currentRoute;\n    }\n  }\n\n  /**\n   * Gets the transaction context for a `NavigationRouteV4`\n   */\n  private _getTransactionContext(\n    route: NavigationRouteV4,\n    previousRoute?: NavigationRouteV4\n  ): ReactNavigationTransactionContext {\n    return {\n      name: route.routeName,\n      op: \"navigation\",\n      tags: {\n        \"routing.instrumentation\":\n          ReactNavigationV4Instrumentation.instrumentationName,\n        \"routing.route.name\": route.routeName,\n      },\n      data: {\n        route: {\n          name: route.routeName, // Include name here too for use in `beforeNavigate`\n          key: route.key,\n          params: route.params ?? {},\n          hasBeenSeen: this._recentRouteKeys.includes(route.key),\n        },\n        previousRoute: previousRoute\n          ? {\n              name: previousRoute.routeName,\n              key: previousRoute.key,\n              params: previousRoute.params ?? {},\n            }\n          : null,\n      },\n    };\n  }\n\n  /**\n   * Gets the current route given a navigation state\n   */\n  private _getCurrentRouteFromState(\n    state: NavigationStateV4\n  ): NavigationRouteV4 {\n    const parentRoute = state.routes[state.index];\n\n    if (\n      \"index\" in parentRoute &&\n      \"routes\" in parentRoute &&\n      typeof parentRoute.index === \"number\" &&\n      Array.isArray(parentRoute.routes)\n    ) {\n      return this._getCurrentRouteFromState(parentRoute);\n    }\n\n    return parentRoute as NavigationRouteV4;\n  }\n\n  /** Pushes a recent route key, and removes earlier routes when there is greater than the max length */\n  private _pushRecentRouteKey = (key: string): void => {\n    this._recentRouteKeys.push(key);\n\n    if (this._recentRouteKeys.length > this._maxRecentRouteLen) {\n      this._recentRouteKeys = this._recentRouteKeys.slice(\n        this._recentRouteKeys.length - this._maxRecentRouteLen\n      );\n    }\n  };\n\n  /** Helper to log a transaction that was not sampled due to beforeNavigate */\n  private _onBeforeNavigateNotSampled = (transactionName: string): void => {\n    logger.log(\n      `[ReactNavigationV4Instrumentation] Will not send transaction \"${transactionName}\" due to beforeNavigate.`\n    );\n  };\n}\n\nconst INITIAL_TRANSACTION_CONTEXT_V4 = {\n  name: \"App Launch\",\n  op: \"navigation\",\n  tags: {\n    \"routing.instrumentation\":\n      ReactNavigationV4Instrumentation.instrumentationName,\n  },\n  data: {},\n};\n\nexport { ReactNavigationV4Instrumentation, INITIAL_TRANSACTION_CONTEXT_V4 };\n"]}